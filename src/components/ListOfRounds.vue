<template>
  <div class="list-rounds-container">
    <div v-for="(stage, index) in previouseStages" :key="index">
      <h3 class="round-label">
        {{ $t('Round') }}
        {{ index + 1 }}
      </h3>
      <div v-if="state ==='completed'" class="round-container round-container_completed">
        <div class="round-container__time-patricipant">
          <div class="round-container_time-completed">
            <img src="/static_texas/images/watch-in-round.svg" alt="watch">
          </div>
          <div class="round-container_participant-completed">
            <div class="round-container_participant-expended">
              {{ stage.label[$store.state.i18n.locale] }}
            </div>
            <div class="round-container_time__watch">
              {{ stage.time | moment("hh:mm:ss") }}
            </div>
          </div>
        </div>
        <div class="round-container_bid">
          <h4 class="round-container_bid__amount">{{ stage.amount }} 
            {{ $t('UAH') }}
          </h4>
        </div>
      </div>

      <div v-else-if="(state ==='active' || state == 'pendingOfRound')" class="round-container round-container_active">
        <div class="round-container__time-patricipant">
          <div class="round-container_time-active">
            <div class="round-container_time__watch-icon">
              <img src="/static_texas/images/watch-in-round.svg" alt="watch">
            </div>
            <div class="round-container_time__watch">
              {{ stage.time | moment("hh:mm:ss") }}
            </div>
          </div>
          <div class="round-container_participant_active">
            {{ stage.label[$store.state.i18n.locale] }}
          </div>
        </div>
        <div class="round-container_bid">
          <h4 class="round-container_bid__amount">{{ stage.amount }}
            {{ $t('UAH') }}
          </h4>
        </div>
      </div>
    </div>

    <div v-if="state ==='active' || state == 'pendingOfRound'" id="active-round">
      <h3 class="round-label">
        {{ $t('Round') }}
        {{ currentRoundNumber }}
      </h3>      
      <div class="round-container round-container_active">
        <div class="round-container__time-patricipant round-container__time-patricipant-active">
          <div class="round-container_time-active">
            <div 
              class="round-container_time-active__watch-icon">
              <radial-progress-bar
                v-if="state !== 'pendingOfRound' && (value > 0 && value < 100)"
                :value="value" :text="remainedTimeOfRound"
                :remained-time-of-round="remainedTimeOfRound"
                min="0" max="100" />
            </div>
            <div class="round-container_time__watch  round-container_time-active__watch">
              {{ stages[stages.length - 1].planned_end | moment("hh:mm:ss") }}
            </div>
          </div>
          <div class="round-container_participant_active" />       
        </div>
        <div class="round-container_bid round-container_bid_active">
          <h4 class="round-container_bid__amount">
            {{ stages[stages.length - 1].amount }}
            {{ $t('UAH') }}
          </h4>
        </div>
      </div>
    </div>
    <div v-if="state ==='completed'">
      <h3 class="round-label">
        {{ $t('Round') }}
        {{ currentRoundNumber }}
      </h3>     
      <div class="round-container round-container_completed">
        <div class="round-container__time-patricipant round-container__time-patricipant-not-set">
          <div class="round-container_time-completed round-container_time-completed_not-set">
            <img src="/static_texas/images/watch-in-round-not-set.svg" alt="watch">
          </div>
          <div class="round-container_time__watch">
            {{ stages[currentStage - 1].planned_end | moment("hh:mm:ss") }}
          </div>
        </div>
        <div class="round-container_bid round-container_bid_not-set">
          <div class="line" />
        </div>
      </div>
    </div>

    <div v-if="state ==='completed' && lastBiddedRound" id="active-round" class="max-round-container">
      <h6 class = "announcement"><strong>
        {{ $t('Announcement') }}
      </strong></h6>
      <div class="round-container_completed round-container round-container_max">
        <div class="round-container__time-patricipant">
          <div class="round-container_time-completed">
            <img src="/static_texas/images/watch-in-round.svg" alt="watch">
          </div>
          <div class="round-container_participant-expended round-container_participant-expended_max">
            <h3 class="word-winner">
              {{ $t('winner') }}
            </h3>
            {{ lastBiddedRound.label[$store.state.i18n.locale] }}
          </div>
          <div class="round-container_time__watch">
            {{ lastBiddedRound.time | moment("hh:mm:ss") }}
          </div>
        </div>
        <div class="round-container_bid round-container_bid_max">
          <h4 class="round-container_bid__amount round-container_bid_max__bid-count">{{ lastBiddedRound.amount }}
            {{ $t('UAH') }}
          </h4>
          <div class="round-container_bid_max-block">
            <div class="round-container_bid_max-block-count">
              MAX
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import RadialProgressBar from './RadialProgressBar.vue'
import AppListInitialOffers from './ListInitialOffers.vue'
import calculatingDurationTime from '../utils/calculatingDurationTime'

export default {
  components: {
    RadialProgressBar,
    AppListInitialOffers
  },
  props: {
    startBid: {
      type: Number,
      default: null
    },
    remainedTimeOfRound: {
      type: Number,
      default: null
    },
    state: {
      type: String,
      default: null
    },
    stages: {
      type: Array,
      default: null
    },
    initialBidsArr: {
      type: Array,
      default: null
    },
    currentStage: {
      type: Number,
      default: null
    },
    currentTime: {
      type: Number,
      default: null
    }
  },
  data () {
    return {
      value: 0,
    }
  },
  computed: {
    previouseStages () {
      let prevStages = []
      for (let i in this.stages) {
        if (this.stages[i].bidder_id) prevStages.push(this.stages[i])
      }
      return prevStages
    },
    currentRoundNumber () {
      return this.previouseStages.length + 1
    },
    lastBiddedRound () {
      if (this.state === 'completed') {
        let reversedStages = this.stages.slice().reverse()
        for (let i in reversedStages) {
          if (reversedStages[i].type === 'english' && reversedStages[i].bidder_id) {
            return reversedStages[i]
          }
        }
      }
      return null
    }
  },
  watch: {
    remainedTimeOfRound() {
      let calculate = calculatingDurationTime(this.stages[this.currentStage].start, this.stages[this.currentStage].planned_end );
      this.value = (100 - (this.remainedTimeOfRound / calculate * 100)).toFixed(2);
    },
    currentRoundNumber(){
      this.$emit('getCurrentRoundNumber', this.currentRoundNumber )
    }
  }
};
</script>

<style scoped>

.round-container{
    display: flex;
    justify-content: space-between;
    width: 100%;
    border: 1px solid #a1a1a1;
    margin-bottom: 25px;
}
.round-container_active{
    height: 50px;
}

.round-container_completed{
    height: 60px;
    margin-top: 10px;
}

.round-container_time-active{
    margin-left: -40px;
    width: 20%;
    display: flex;
    justify-content: space-between;
}

.round-container_participant-completed {
    width: 89%;
    display: flex;
    justify-content: space-between;
    height: 90%;
    align-items: center;
}

.round-container_time-completed{
    width: 10%;
    display:flex;
    justify-content: center;
}

.round-container__time-patricipant{
    width: 70%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    font-family: 'Montserrat', sans-serif;
    font-size: 18px;
    font-weight: 500;
}

.round-container__time-patricipant-active{
    height: 95%;
    background-color: #e7f5ac;
    margin: auto;
    margin-left: 1px;
}

.round-container__time-patricipant-not-set {
   justify-content: initial;
}
.round-container_time__watch {
    font-size: 18px;
    font-weight: 300;
    font-family: 'Oswald', sans-serif;
    display: flex;
    align-items: center
}


.round-container_bid{
    display: flex;
    justify-content: center;
    align-items: center;
    align-self: center;
    min-width: 30%;
    height: 90%;
    background-color: #e9e9e9;
    margin-right: 3px;
}

.round-container_bid_not-set {
    position: relative;
    background-color: initial;
}

.line {
    width: 112px;
    height: 47px;
    border-bottom: 1px solid black;
    position: absolute;
    bottom: 40%; 
}

.round-container_bid__amount {
    font-family: 'Oswald', sans-serif;
    font-size: 20px;
    font-weight: 400;
}

.round-container_bid_active{
    height: 95%;
    background-color: #e7f5ac;
    margin: auto;
    margin-right: 1px;
}

.round-container_participant_active{
    width: 35%;
    text-align: center;
    font-family: 'Montserrat', sans-serif;
    font-size: 18px;
    font-weight: 800;
    line-height: 21.18px;
}

.max-round-container{
    margin-top: 30px;
}

.round-container_max{
    background-color: #e7f5ac;
    margin-top: 15px;
    padding-left: 5px;
}

.round-container_participant__order-number{
    display: flex;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    font-weight: 400;
}

.round-container_participant-expended {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    width: 90%;
    height: 100%;
    display: flex;
    align-items: center;
    word-break: break-all;
    margin-right: 10px;
}

.round-container_participant-expended_max {
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
}

.round-container_bid_max{
    background-color: #e7f5ac;
    justify-content: space-between;
}

.round-container_bid_max-block{
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ffffff;
    height: 100%;
    width: 17px;
    font-size: initial;
}

.round-container_bid_max__bid-count{
    margin: 0 auto;
}

.round-container_bid_max-block-count{
    transform: rotate(-90deg);
    color: #000000;
    font-family: 'Montserrat', sans-serif;
}

.round-label {
    font-family: 'Roboto', sans-serif;
    font-size: 16px;
    font-weight: 600;
    line-height: 16px;
    margin-bottom: 10px;
}

.announcement {
    font-size: 16px;
    font-weight: 500;
    font-family: 'Roboto', sans-serif;
}

.word-winner {
  text-transform: uppercase;
}

</style>